<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css">
  <link rel="stylesheet" href="../css/additional.css">
  <link rel="stylesheet" href="../css/farese.css">
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.js"></script>
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.1.0/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.1.0/mapbox-gl-geocoder.css" type="text/css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <!-- Header bar theme -->
  <meta name="theme-color" content="#00538f">
  <!-- Android Chrome header color -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- Fullscreen mode for iOS Safari -->
  <meta name="apple-mobile-web-app-status-bar-style" content="#00538f">
  <!-- iOS Safari header color -->
  <meta name="msapplication-navbutton-color" content="#00538f">
  <!-- Windows phone header color -->
</head>

<body>
  <nav class="navbar navbar-expand-md bg-primary navbar-dark border border-primary">
    <div class="container">
      <a class="navbar-brand" href=".">Farese.com</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbar2SupportedContent" aria-controls="navbar2SupportedContent" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button>
      <div class="collapse navbar-collapse text-center justify-content-end" id="navbar2SupportedContent">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item text-center">
            <a class="nav-link text-light" href=".">Home</a>
          </li>
          <li class="nav-item text-center">
            <a class="nav-link text-light" href="about">About</a>
          </li>
          <li class="nav-item text-center">
            <a class="nav-link text-light" href="map">Map</a>
          </li>
          <li class="nav-item text-center">
            <a class="nav-link text-light" href="archive">Archive</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="h-100" id="map"></div>
  <script>
    var isDataLoaded = false;
    var isStyleLoaded = false;
    var markers;

    mapboxgl.accessToken = 'pk.eyJ1IjoibGFpbiIsImEiOiJjaWhzbHBpMXMwMHNldGdtMWgxbGp4aWRoIn0.BE_Fxskfnqumxa_5FLBWcA';

    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v9',
        center: [-98.583333,39.833333],
        zoom: 2,
        hash: true,
    });

    var loadMap = function () {
       // Add marker data as a new GeoJSON source.
       map.addSource("markers", {
          "type": "geojson",
          "data": markers
       });

       // Add a layer showing the markers.
       map.addLayer({
          "id": "markers",
          "interactive": true,
          "type": "circle",
          "source": "markers",
          "paint": {
                  "circle-radius": 6,
                  "circle-color": "#007cbf",
                  "circle-stroke-width": 1.7,
                  "circle-stroke-color": "#eeeeee",
          }
       });

       // When a click event occurs near a marker icon, open a popup at the location of
       // the feature, with description HTML from its properties.
       map.on('click', function (e) {
           var bboxSize = 25;
           var bbox = [[e.point.x - bboxSize, e.point.y - bboxSize], [e.point.x + bboxSize, e.point.y + bboxSize]];
           var features = map.queryRenderedFeatures(bbox, { layers: ['markers'] });

           if (!features.length) {
               return;
           }

           var feature = features[0];

           // Populate the popup and set its coordinates
           // based on the feature found.
           var popup = new mapboxgl.Popup()
              .setLngLat(feature.geometry.coordinates)
              .setHTML('<h2>'+feature.properties.name+'</h2>'  + feature.properties.address + '<br>' + '<a href="'+feature.properties.website+'">'+feature.properties.website+'</a>' + feature.properties.note)
              .addTo(map);

           // Pan to clicked marker
           if (features.length) {
              // Get coordinates from the symbol and center the map on those coordinates
              map.flyTo({
                 center: features[0].geometry.coordinates,
                 speed: 0.3
              });
           }
       });

       // Use the same approach as above to indicate that the symbols are clickable
       // by changing the cursor style to 'pointer'.
       map.on('mousemove', function (e) {
          var features = map.queryRenderedFeatures(e.point, { layers: ['markers'] });
          map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
       });
    }

    // disable map rotation using right click + drag
    map.dragRotate.disable();

    // disable map rotation using touch rotation gesture
    map.touchZoomRotate.disableRotation();

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl, 'top-left');

    // Add geocoder
    map.addControl(new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        placeholder: "Search by location",
        limit: 3,
    }));

    // Load GeoJSON data

    var shouldLoadMap = function () {
       return isDataLoaded && isStyleLoaded
    }


    jQuery.getJSON("data.json", function(json) {
          markers = json;
          isDataLoaded = true;
          if (shouldLoadMap()) {
             loadMap()
          }
    })

    map.on('style.load', function () {
       isStyleLoaded = true;
       if (shouldLoadMap()) {
          loadMap()
       }
    });
  </script>
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
  <script src="https://pingendo.com/assets/bootstrap/bootstrap-4.0.0-alpha.6.min.js"></script>
</body>

</html>